name: Schema Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate-schema:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        npm install
        npm install -g ajv-cli
        
    - name: Validate schema itself
      run: |
        echo "Validating RTM schema against JSON Schema meta-schema..."
        ajv compile -s schema/rtm-schema.json
        
    - name: Validate all example files
      run: |
        echo "Validating all example RTM files..."
        if ls examples/*.yaml 1> /dev/null 2>&1; then
          find examples -name "*.yaml" -o -name "*.yml" | while read file; do
            echo "Validating $file"
            ajv validate -s schema/rtm-schema.json -d "$file"
          done
        else
          echo "No example files found, skipping validation"
        fi
        
    - name: Test valid examples (if exist)
      run: |
        echo "Testing valid examples..."
        if [ -d "tests/valid" ]; then
          find tests/valid -name "*.yaml" -o -name "*.yml" | while read file; do
            echo "Validating $file (should pass)"
            if ! ajv validate -s schema/rtm-schema.json -d "$file"; then
              echo "âŒ FAILED: $file should be valid but validation failed"
              exit 1
            else
              echo "âœ… PASSED: $file is valid"
            fi
          done
        else
          echo "No tests/valid directory found, skipping valid tests"
        fi
        
    - name: Test invalid examples (if exist)
      run: |
        echo "Testing invalid examples..."
        if [ -d "tests/invalid" ]; then
          find tests/invalid -name "*.yaml" -o -name "*.yml" | while read file; do
            echo "Validating $file (should fail)"
            if ajv validate -s schema/rtm-schema.json -d "$file" 2>/dev/null; then
              echo "âŒ FAILED: $file should be invalid but validation passed"
              exit 1
            else
              echo "âœ… PASSED: $file correctly failed validation"
            fi
          done
        else
          echo "No tests/invalid directory found, skipping invalid tests"
        fi
        
    - name: Generate validation report
      run: |
        echo "## Validation Report" > validation-report.md
        echo "" >> validation-report.md
        echo "### Schema Validation: âœ… PASSED" >> validation-report.md
        echo "### Example Files:" >> validation-report.md
        
        if ls examples/*.yaml 1> /dev/null 2>&1; then
          valid_count=$(find examples -name "*.yaml" -o -name "*.yml" | wc -l)
          echo "- Valid examples: $valid_count files âœ…" >> validation-report.md
        else
          echo "- Valid examples: 0 files (none found)" >> validation-report.md
        fi
        
        if [ -d "tests/valid" ]; then
          test_valid_count=$(find tests/valid -name "*.yaml" -o -name "*.yml" | wc -l)
          echo "- Test valid: $test_valid_count files âœ…" >> validation-report.md
        else
          echo "- Test valid: 0 files (directory not found)" >> validation-report.md
        fi
        
        if [ -d "tests/invalid" ]; then
          test_invalid_count=$(find tests/invalid -name "*.yaml" -o -name "*.yml" | wc -l)
          echo "- Test invalid: $test_invalid_count files âœ…" >> validation-report.md
        else
          echo "- Test invalid: 0 files (directory not found)" >> validation-report.md
        fi
        
        echo "" >> validation-report.md
        echo "All validations completed successfully! ðŸŽ‰" >> validation-report.md
        
        cat validation-report.md
        
    - name: Upload validation report
      uses: actions/upload-artifact@v4
      with:
        name: validation-report
        path: validation-report.md

  lint-yaml:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install yamllint
      run: pip install yamllint
      
    - name: Create yamllint config
      run: |
        cat > .yamllint << 'EOF'
extends: default
rules:
  line-length:
    max: 120
  indentation:
    spaces: 2
  comments:
    min-spaces-from-content: 1
EOF
        
    - name: Lint YAML files
      run: |
        echo "Linting all YAML files..."
        find . -name "*.yaml" -o -name "*.yml" | grep -v node_modules | while read file; do
          echo "Linting $file"
          yamllint "$file" || true
        done

  check-links:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js  
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install markdown-link-check
      run: npm install -g markdown-link-check
      
    - name: Create link-check config
      run: |
        cat > .markdown-link-check.json << 'EOF'
{
  "ignorePatterns": [
    {
      "pattern": "^https://github.com/yourusername"
    },
    {
      "pattern": "^mailto:"
    }
  ],
  "timeout": "20s",
  "retryOn429": true,
  "retryCount": 2,
  "fallbackRetryDelay": "30s",
  "aliveStatusCodes": [200, 206]
}
EOF
      
    - name: Check links in documentation
      run: |
        echo "Checking links in documentation..."
        find . -name "*.md" | while read file; do
          echo "Checking links in $file"
          markdown-link-check "$file" --config .markdown-link-check.json || true
        done

  validate-examples-cross-platform:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        validator: ['ajv-cli', 'jsonschema']
        
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install validators
      run: |
        if [ "${{ matrix.validator }}" = "ajv-cli" ]; then
          npm install -g ajv-cli
        elif [ "${{ matrix.validator }}" = "jsonschema" ]; then
          pip install jsonschema pyyaml
        fi
        
    - name: Validate with ${{ matrix.validator }}
      run: |
        if [ "${{ matrix.validator }}" = "ajv-cli" ]; then
          if ls examples/*.yaml 1> /dev/null 2>&1; then
            find examples -name "*.yaml" | while read file; do
              echo "Validating $file with ajv-cli"
              ajv validate -s schema/rtm-schema.json -d "$file"
            done
          else
            echo "No example files found for ajv-cli validation"
          fi
        elif [ "${{ matrix.validator }}" = "jsonschema" ]; then
          cat > validate_with_jsonschema.py << 'EOF'
import json
import yaml
import jsonschema
import glob
import sys
import os

# Check if schema file exists
if not os.path.exists('schema/rtm-schema.json'):
    print("âŒ Schema file not found: schema/rtm-schema.json")
    sys.exit(1)

with open('schema/rtm-schema.json') as f:
    schema = json.load(f)

yaml_files = glob.glob('examples/**/*.yaml', recursive=True)
if not yaml_files:
    print("No YAML files found in examples directory")
    sys.exit(0)

for yaml_file in yaml_files:
    print(f'Validating {yaml_file} with jsonschema')
    try:
        with open(yaml_file) as f:
            data = yaml.safe_load(f)
        jsonschema.validate(data, schema)
        print(f'âœ… {yaml_file} is valid')
    except jsonschema.exceptions.ValidationError as e:
        print(f'âŒ {yaml_file} is invalid: {e}')
        sys.exit(1)
    except Exception as e:
        print(f'âŒ Error processing {yaml_file}: {e}')
        sys.exit(1)
EOF
          python validate_with_jsonschema.py
        fi